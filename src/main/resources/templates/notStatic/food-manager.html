<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Shop Manager</title>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #F2E6EE, #977DFF);
          }
        .upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Back Navigation */
        .back-navigation {
          position: absolute;
          top: 20px;
          left: 20px;
          z-index: 10;
        }

        .back-btn {
          background: var(--surface);
          backdrop-filter: blur(10px);
          border: 1px solid var(--glass-border);
          border-radius: 25px;
          padding: 12px 20px;
          font-family: 'Inter', sans-serif;
          font-weight: 500;
          color: var(--text-primary);
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: var(--transition);
          box-shadow: var(--shadow-soft);
          text-decoration: none;
        }

        .back-btn:hover {
          background: rgba(255, 255, 255, 1);
          transform: translateY(-2px);
          box-shadow: var(--shadow-elevated);
        }
    </style>
</head>
<body>
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">üçΩÔ∏è Food Shop Manager</h1>
        <p class="text-gray-600">Manage your food shop and menu items</p>
    </div>

    <div class="back-navigation">
        <button class="back-btn" onclick="window.location.href = '/protected/home';">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Home</span>
        </button>
    </div>

    <!-- Shop Display Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Shop</h2>
        <div class="flex flex-col md:flex-row items-center gap-6">
            <div id="shopImageDisplay" class="w-32 h-32 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                <span class="text-gray-400 text-sm text-center">No Image<br>Uploaded</span>
            </div>
            <div class="flex-1">
                <h3 id="shopNameDisplay" class="text-xl font-semibold text-gray-800 mb-2">Shop Name Not Set</h3>
                <p id="shopDescDisplay" class="text-gray-600">Shop description not provided yet.</p>
            </div>
        </div>
    </div>

    <!-- Shop Setup Form -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Shop Setup</h2>

        <!-- Shop Image Upload -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Shop Image</label>
            <div class="upload-area rounded-lg p-6 text-center cursor-pointer" onclick="document.getElementById('shopImageInput').click()">
                <div class="text-gray-500">
                    <svg class="mx-auto h-12 w-12 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="text-sm">Click to upload shop image</p>
                    <p class="text-xs text-gray-400">PNG, JPG up to 10MB</p>
                </div>
            </div>
            <input type="file" id="shopImageInput" accept="image/*" class="hidden" onchange="handleShopImageUpload(this)">
            <div id="shopImagePreview" class="mt-4 hidden">
                <p class="text-sm text-gray-600 mb-2">Preview:</p>
                <img id="shopImagePreviewImg" class="w-24 h-24 object-cover rounded-lg border">
            </div>
        </div>

        <!-- Shop Details Form -->
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <label for="shopName" class="block text-sm font-medium text-gray-700 mb-2">Shop Name</label>
                <input type="text" id="shopName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Enter your shop name">
            </div>
            <div>
                <label for="shopDescription" class="block text-sm font-medium text-gray-700 mb-2">Shop Description</label>
                <textarea id="shopDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Describe your food shop"></textarea>
            </div>
        </div>

        <button onclick="updateShopInfo()" class="mt-4 bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
            Update Shop Info
        </button>
    </div>

    <!-- Add Food Item Form -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Add Food Item</h2>

        <!-- Food Image Upload -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Food Image</label>
            <div class="upload-area rounded-lg p-6 text-center cursor-pointer" onclick="document.getElementById('foodImageInput').click()">
                <div class="text-gray-500">
                    <svg class="mx-auto h-12 w-12 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="text-sm">Click to upload food image</p>
                    <p class="text-xs text-gray-400">PNG, JPG up to 10MB</p>
                </div>
            </div>
            <input type="file" id="foodImageInput" accept="image/*" class="hidden" onchange="handleFoodImageUpload(this)">
            <div id="foodImagePreview" class="mt-4 hidden">
                <img id="foodImagePreviewImg" class="w-24 h-24 object-cover rounded-lg border">
            </div>
        </div>

        <!-- Food Details Form -->
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <label for="foodName" class="block text-sm font-medium text-gray-700 mb-2">Food Name</label>
                <input type="text" id="foodName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Enter food name">
            </div>
            <div>
                <label for="foodPrice" class="block text-sm font-medium text-gray-700 mb-2">Food Price ($)</label>
                <input type="number" id="foodPrice" max="3500" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Enter price (max $3500)">
                <p class="text-xs text-gray-500 mt-1">Maximum price allowed: $3500</p>
            </div>
        </div>

        <!-- new: Food Description Field -->
        <div class="mt-6">
            <label for="foodDescription" class="block text-sm font-medium text-gray-700 mb-2">Food Description</label>
            <textarea id="foodDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Describe this food item (ingredients, taste, etc.)"></textarea>
        </div>

        <button onclick="addFoodItem()" class="mt-6 bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
            Add Food Item
        </button>
    </div>

    <!-- Food Items Display -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Menu Items</h2>
        <div id="foodItemsList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="text-center text-gray-500 py-8 col-span-full">
                No food items added yet. Add your first item above!
            </div>
        </div>
    </div>
</div>

<script>
    let shopImageData = null;
    let foodItems = [];
    let shopImageFile = null;
    let csrfToken = null;
    let csrfHeaderName = null;
    let shopId = null;

    window.addEventListener("DOMContentLoaded", async () => {
          // 1. Fetch CSRF token
          const csrfResponse = await fetch("/csrf-token");
          const csrfData = await csrfResponse.json();
          csrfToken = csrfData.token;
          csrfHeaderName = csrfData.headerName;
          console.log("CSRF Token Loaded:", csrfHeaderName, csrfToken);
    });

    function handleShopImageUpload(input) {
        const file = input.files[0];
        if (file) {
            shopImageFile = file; // store file globally
            const reader = new FileReader();
            reader.onload = function(e) {
                shopImageData = e.target.result;
                const preview = document.getElementById('shopImagePreview');
                const img = document.getElementById('shopImagePreviewImg');
                img.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    function handleFoodImageUpload(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('foodImagePreview');
                const img = document.getElementById('foodImagePreviewImg');
                img.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    async function updateShopInfo() {
        const shopName = document.getElementById('shopName').value.trim();
        const shopDescription = document.getElementById('shopDescription').value.trim();

        if (!shopName) {
            alert('Please enter a shop name');
            return;
        }

        if (!shopImageFile) {
            alert('Please select a shop image');
            return;
        }

        // Build FormData for backend
        const formData = new FormData();
        formData.append("businessName", shopName);
        formData.append("businessDescription", shopDescription);
        formData.append("imageFile", shopImageFile);

        try {
            const response = await fetch("/api/business", {
                method: "POST",
                headers:{[csrfHeaderName]: csrfToken},
                body: formData
            });

            if (!response.ok) {
                throw new Error("Failed to save business");
            }

            const savedBusiness = await response.json();
            console.log("Saved business:", savedBusiness);

            // Update frontend display
            document.getElementById('shopNameDisplay').textContent = savedBusiness.name;
            document.getElementById('shopDescDisplay').textContent = savedBusiness.description;

            const display = document.getElementById('shopImageDisplay');
            display.innerHTML = `<img src="${savedBusiness.imagePath}" alt="Shop Image" class="w-full h-full object-cover rounded-lg">`;


            // Clear form and preview
            document.getElementById('shopName').value = '';
            document.getElementById('shopDescription').value = '';
            document.getElementById('shopImageInput').value = '';
            document.getElementById('shopImagePreview').classList.add('hidden');
            shopImageData = null;
            shopImageFile = null;

            alert('Shop information saved successfully!');
        } catch (error) {
            console.error(error);
            alert("Error saving shop info");
        }
    }


    async function addFoodItem() {
        const foodName = document.getElementById('foodName').value.trim();
        const foodPrice = parseFloat(document.getElementById('foodPrice').value);
        const foodImageInput = document.getElementById('foodImageInput');
        const foodDescription = document.getElementById('foodDescription').value.trim();

        // === Validation ===
        if (!foodName) {
            alert('Please enter a food name');
            return;
        }

        if (!foodPrice || foodPrice <= 0) {
            alert('Please enter a valid price');
            return;
        }

        if (foodPrice > 3500) {
            alert('Price cannot be greater than $3500');
            return;
        }

        if (!foodImageInput.files[0]) {
            alert('Please upload a food image');
            return;
        }

        if (!foodDescription) {
            alert('Please enter a description');
            return;
        }

        // === Prepare FormData ===
        const formData = new FormData();
        formData.append("foodName", foodName);
        formData.append("foodDescription", foodDescription);
        formData.append("foodPrice", foodPrice);
        formData.append("imageFile", foodImageInput.files[0]);

        try {
            const response = await fetch(`/api/foods/${shopId}/add`, {
                method: "POST",
                headers:{[csrfHeaderName]: csrfToken},
                body: formData
            });

            if (!response.ok) {
                throw new Error("Failed to add food item");
            }

            const savedFood = await response.json();

            // Show confirmation
            alert("‚úÖ Food item added successfully!");

            // Optionally update UI list with backend response
            foodItems.push({
                id: savedFood.foodId,
                name: savedFood.foodName,
                price: savedFood.foodPrice,
                image: savedFood.foodImagePath, // backend returns the saved URL
                description: savedFood.foodDescription
            });

            displayFoodItems();
            clearFoodForm();


        } catch (error) {
            console.error("Error adding food:", error);
            alert("‚ùå Something went wrong while adding the food item.");
        }
    }


    function displayFoodItems() {
        const container = document.getElementById('foodItemsList');

        if (foodItems.length === 0) {
            container.innerHTML =
                '<div class="text-center text-gray-500 py-8 col-span-full">No food items added yet. Add your first item above!</div>';
            return;
        }

        container.innerHTML = foodItems.map(item => `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow" data-id="${item.id}">
                <img src="${item.image}" alt="${item.name}" class="w-full h-32 object-cover rounded-lg mb-3">
                <h3 class="font-semibold text-gray-800 mb-1">${item.name}</h3>
                <p class="text-gray-600 text-sm mb-2">${item.description}</p>
                <p class="text-green-600 font-bold">$${parseFloat(item.price).toFixed(2)}</p>
                <button onclick="removeFoodItem(${item.id})" class="mt-2 text-red-500 hover:text-red-700 text-sm">Remove</button>
            </div>
        `).join('');
    }

    function removeFoodItem(id) {
        if (confirm('Are you sure you want to remove this item?')) {
            foodItems = foodItems.filter(item => item.id !== id);
            displayFoodItems();
        }
    }

    function clearFoodForm() {
        document.getElementById('foodName').value = '';
        document.getElementById('foodPrice').value = '';
        document.getElementById('foodImageInput').value = '';
        document.getElementById('foodImagePreview').classList.add('hidden');
        document.getElementById('foodDescription').value = ''; // new: Clear description field
    }

    // Price validation on input
    document.getElementById('foodPrice').addEventListener('input', function() {
        const value = parseFloat(this.value);
        if (value > 3500) {
            this.setCustomValidity('Price cannot exceed $3500');
            this.style.borderColor = '#ef4444';
        } else {
            this.setCustomValidity('');
            this.style.borderColor = '#d1d5db';
        }
    });


    async function loadMyBusiness() {
        try {
            const response = await fetch("/api/business/me", {
                method: "GET",
                headers: { [csrfHeaderName]: csrfToken } // only if CSRF is enabled
            });

            if (!response.ok) {
                console.warn("No business found for current user");
                return;
            }

            const business = await response.json();


            // ‚úÖ Update Shop Display
            document.getElementById('shopNameDisplay').textContent = business.name || "Shop Name Not Set";
            document.getElementById('shopDescDisplay').textContent = business.description || "Shop description not provided yet.";

            const display = document.getElementById('shopImageDisplay');
            if (business.imagePath) {
                display.innerHTML = `<img src="${business.imagePath}" alt="Shop Image" class="w-full h-full object-cover rounded-lg">`;
            } else {
                display.innerHTML = `<span class="text-gray-400 text-sm text-center">No Image<br>Uploaded</span>`;
            }

            return business.id;

        } catch (error) {
            console.error("Error loading business:", error);
            return null;
        }
    }

    async function loadFoods(shopId) {
        try {
            const response = await fetch(`/api/foods/shop/${shopId}`);
            if (!response.ok) {
                throw new Error("Failed to fetch foods");
            }

            const foods = await response.json();

            // Replace existing items with backend data
            foodItems = foods.map(f => ({
                id: f.foodId,
                name: f.foodName,
                price: f.foodPrice,
                image: f.foodImagePath,
                description: f.foodDescription,
            }));

            displayFoodItems();

        } catch (error) {
            console.error("Error loading foods:", error);
            document.getElementById("foodItemsList").innerHTML =
                '<div class="text-center text-red-500 py-8 col-span-full">Error loading foods. Please try again later.</div>';
        }
    }

    // Call on page load
    document.addEventListener("DOMContentLoaded", async () => {
        shopId = await loadMyBusiness(); // wait until loaded
        if (shopId) {
            await loadFoods(shopId); // only call if business exists
        } else {
            console.warn("No shop found, skipping food load.");
        }
    });


</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978eb4107246a035',t:'MTc1NjgzMzg5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
